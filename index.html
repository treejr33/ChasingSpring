<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="Spring Chasers - Bird Migration Visualization" />
        <title>候鸟逐春 Spring Chasers</title>
        
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Noto+Serif+SC:wght@300;700&display=swap" rel="stylesheet">
        
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <link href="css/styles.css" rel="stylesheet" />
        <link href="css/custom.css" rel="stylesheet" />

        <style>
            .legend-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; flex-shrink: 0; }
            .legend-line { display: inline-block; width: 15px; height: 2px; margin-right: 6px; vertical-align: middle; flex-shrink: 0; }
        </style>
    </head>
    <body id="page-top">
        
        <button class="lang-switch-btn" onclick="toggleLanguage()">
            <i class="fas fa-globe"></i> <span id="lang-btn-text">EN</span>
        </button>

        <div class="video-background-holder">
            <div class="video-overlay"></div>
            <video autoplay muted loop playsinline id="bg-video">
                <source src="assets/bg-video.mp4" type="video/mp4">
            </video>
        </div>

        <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
            <div class="container px-4 px-lg-5 p-0">
                <a class="navbar-brand text-white" href="#page-top">
                    <span class="lang-zh">候鸟逐春</span><span class="lang-en">SPRING CHASERS</span>
                </a>
                <button class="navbar-toggler navbar-toggler-right bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link text-white-50 fw-bold" href="#about">
                            <span class="lang-zh">迁徙奥秘</span><span class="lang-en">The Journey</span>
                        </a></li>
                        <li class="nav-item"><a class="nav-link text-white-50 fw-bold" href="#map-section">
                            <span class="lang-zh">迁徙地图</span><span class="lang-en">Migration Map</span>
                        </a></li>
                        <li class="nav-item"><a class="nav-link text-white-50 fw-bold" href="#contact">
                            <span class="lang-zh">加入我们</span><span class="lang-en">Get Involved</span>
                        </a></li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <header class="masthead">
            <div class="hero-box">
                <h1 class="hero-title">
                    <span class="lang-zh">候鸟逐春</span>
                    <span class="lang-en">SPRING CHASERS</span>
                </h1>
                <div class="hero-subtitle">
                    <span class="lang-zh">中国候鸟迁徙与气温变化可视化</span>
                    <span class="lang-en">Tracking the Warmth: A Migration Visualization</span>
                </div>
                <div>
                    <a class="btn btn-hero" href="#map-section">
                        <span class="lang-zh">开启旅程</span><span class="lang-en">Explore Map</span>
                    </a>
                </div>
            </div>
            <div class="tm-next" style="position:absolute; bottom:40px;">
                <a href="#about"><i class="fas fa-caret-down tm-down-arrow"></i></a>
            </div> 
        </header>

        <section class="about-section text-center" id="about">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="text-white mb-4 brand-font">
                            <span class="lang-zh">逐温而行：生命的节律</span>
                            <span class="lang-en">Chasing Isotherms: The Rhythm of Life</span>
                        </h2>
                        <p class="text-white-50 fs-5">
                            <span class="lang-zh">候鸟的迁徙是一场对能量与时机的精准计算。为了生存，它们不仅要追随 <strong>5°C - 10°C</strong> 的舒适温区，还要避开拥挤的旧路线，寻找新的食物补给点。本项目还原了三大候鸟种群的真实迁徙策略。</span>
                            <span class="lang-en">Migration is a delicate balance of energy and timing. Driven by survival, these travelers don't just fly north—they follow the <strong>5°C - 10°C</strong> isotherm, riding the invisible wave of spring. This project visualizes the authentic strategies of three major bird populations.</span>
                        </p>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="projects-section" id="map-section">
            <div class="container px-4 px-lg-5">
                <div class="text-center mb-5">
                    <h2 class="text-black brand-font">
                        <span class="lang-zh">候鸟迁徙全周期模拟</span>
                        <span class="lang-en">Annual Cycle Simulation</span>
                    </h2>
                    <p class="text-muted">
                        <span class="lang-zh">点击播放，<strong style="color:#64a19d;">悬停几何图标</strong> 查看实时状态</span>
                        <span class="lang-en">Press Play to start. <strong style="color:#64a19d;">Hover</strong> over birds for live status.</span>
                    </p>
                </div>

                <div class="row gx-0 mb-5">
                    <div class="col-xl-8 col-lg-7 p-0 position-relative">
                        <div id="map"></div>

                        <div class="sidebar-wrapper">
                            <div class="sidebar-trigger-btn" title="查看详细信息"><i class="fas fa-info"></i></div>
                            <div class="sidebar-panel">
                                <div class="sidebar-content-inner" id="sidebar-content"></div>
                            </div>
                        </div>

                        <button id="play-btn" class="play-control-btn" onclick="togglePlay()"><i class="fas fa-play"></i></button>

                        <div style="position: absolute; bottom: 30px; right: 30px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px; display:flex; align-items:center;">
                            <div style="width:10px; height:80px; background:linear-gradient(to top, #0000FF, #FFFF00, #FF0000); margin-right:10px;"></div>
                            <div style="height:80px; display:flex; flex-direction:column; justify-content:space-between; font-size:0.7rem; font-weight:bold;">
                                <span>35°C</span><span>5°C</span><span>-25°C</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-4 col-lg-5 d-none d-lg-block" style="min-height: 700px;"></div>
                    
                    <div class="col-12">
                        <div class="slider-container-bottom">
                            <span id="current-month-label" style="font-size: 1.5rem; font-weight: 800; color: #2c3e50; width: 100px; text-align: center;">1月</span>
                            <input type="range" id="month-slider" min="1" max="12" value="1" step="1" style="flex-grow: 1;">
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="signup-section" id="contact">
            <div class="container px-4 px-lg-5 text-center">
                <i class="far fa-paper-plane fa-2x mb-4 text-white"></i>
                <h2 class="text-white mb-4 brand-font">
                    <span class="lang-zh">关注候鸟保护计划</span>
                    <span class="lang-en">Protect the Migratory Birds</span>
                </h2>
                <form class="col-md-6 mx-auto d-flex">
                    <input class="form-control me-2" type="email" placeholder="Email..." />
                    <button class="btn btn-primary" type="button">
                        <span class="lang-zh">订阅</span><span class="lang-en">Subscribe</span>
                    </button>
                </form>
            </div>
        </section>

        <footer class="footer bg-black small text-center text-white-50 py-4">
            <div class="container">Copyright &copy; Spring Chasers 2025</div>
        </footer>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

        <script>
            // --- 全局变量 ---
            let currentLang = 'zh'; 
            let currentMonth = 1;
            const TILE_BASE_URL = './tiles/2024-'; 
            
            // 存储候鸟 Marker 实例
            const birdMarkers = {}; 
            // [新增] 存储绘制路线的定时器，用于清除未完成的动画
            let routeDrawTimeouts = [];

            // --- 1. 语言切换 ---
            function toggleLanguage() {
                const body = document.body;
                const btnText = document.getElementById('lang-btn-text');
                if (currentLang === 'zh') {
                    currentLang = 'en';
                    body.classList.add('en-mode');
                    btnText.textContent = 'CN'; 
                } else {
                    currentLang = 'zh';
                    body.classList.remove('en-mode');
                    btnText.textContent = 'EN'; 
                }
                updateBirdMigration(currentMonth);
                renderSidebar(); 
                updateMonthLabel();
            }

            // --- 2. 数据中心 ---
            const birdData = {
                east: {
                    id: 'crane',
                    name_zh: "东线：丹顶鹤", name_en: "East: Red-crowned Crane",
                    color: "#FF7F50",
                    sidebar_info_zh: `<strong>习性：</strong> 沿海“逐水而居”，依赖芦苇湿地。<br><strong>路线：</strong> 盐城(冬) <i class="fas fa-arrows-alt-v"></i> 扎龙(夏)`,
                    sidebar_info_en: `<strong>Habit:</strong> Coastal dweller, wetland dependent.<br><strong>Route:</strong> Yancheng <i class="fas fa-arrows-alt-v"></i> Zhalong`,
                    monthlyData: [
                        { pos: [33.38, 120.13], desc_zh: "<b>[越冬·盐城]</b> 在芦苇丛中通过吞食鱼虾积累脂肪。", desc_en: "<b>[Wintering]</b> Building fat reserves in wetlands." },
                        { pos: [33.50, 120.20], desc_zh: "<b>[越冬末期]</b> 鹤群开始活跃，进行北迁前集结。", desc_en: "<b>[Rallying]</b> Preparing for northward migration." },
                        { pos: [37.75, 118.95], desc_zh: "<b>[北迁·黄河口]</b> 飞抵黄河三角洲停歇补给。", desc_en: "<b>[Refueling]</b> Stopover at Yellow River Delta." },
                        { pos: [41.12, 121.12], desc_zh: "<b>[北迁·辽宁]</b> 随着5°C等温线北移穿越环渤海。", desc_en: "<b>[Migration]</b> Crossing the Bohai Rim." },
                        { pos: [47.20, 124.25], desc_zh: "<b>[抵达·扎龙]</b> 终于到达繁殖地，开始筑巢。", desc_en: "<b>[Arrival]</b> Reaching Zhalong breeding grounds." },
                        { pos: [47.30, 124.30], desc_zh: "<b>[繁殖期]</b> 正在孵化卵，利用芦苇作屏障。", desc_en: "<b>[Breeding]</b> Incubation phase." },
                        { pos: [47.25, 124.20], desc_zh: "<b>[育雏期]</b> 雏鸟破壳，在浅水中学习觅食。", desc_en: "<b>[Nurturing]</b> Chicks learning to forage." },
                        { pos: [47.00, 124.00], desc_zh: "<b>[练飞期]</b> 幼鸟羽翼渐丰，家族群开始集结。", desc_en: "<b>[Fledging]</b> Young birds practicing flight." },
                        { pos: [44.50, 122.00], desc_zh: "<b>[南迁·吉林]</b> 气温骤降，避开寒冷沿海风口。", desc_en: "<b>[Southbound]</b> Avoiding coastal winds." },
                        { pos: [38.00, 117.50], desc_zh: "<b>[南迁·河北]</b> 借助秋季强劲北风滑翔。", desc_en: "<b>[Gliding]</b> Riding the autumn thermals." },
                        { pos: [34.50, 118.50], desc_zh: "<b>[南迁·江苏]</b> 抵达连云港，回到越冬地前最后一站。", desc_en: "<b>[Rest]</b> Stopover at Lianyungang." },
                        { pos: [33.38, 120.13], desc_zh: "<b>[回归·盐城]</b> 回到温暖的南方湿地，安度寒冬。", desc_en: "<b>[Return]</b> Back to winter sanctuary." }
                    ]
                },
                mid: {
                    id: 'swan',
                    name_zh: "中线：小天鹅", name_en: "Mid: Tundra Swan",
                    color: "#20c997",
                    sidebar_info_zh: `<strong>习性：</strong> 耐力惊人，能跨越内陆干旱区。<br><strong>路线：</strong> 鄱阳湖(冬) <i class="fas fa-arrows-alt-v"></i> 西伯利亚(夏)`,
                    sidebar_info_en: `<strong>Habit:</strong> High endurance, crosses arid lands.<br><strong>Route:</strong> Poyang <i class="fas fa-arrows-alt-v"></i> Siberia`,
                    monthlyData: [
                        { pos: [29.10, 116.68], desc_zh: "<b>[越冬·鄱阳湖]</b> 利用长颈挖掘浅滩下的块茎。", desc_en: "<b>[Wintering]</b> Digging for tubers at Poyang." },
                        { pos: [30.00, 115.50], desc_zh: "<b>[越冬·龙感湖]</b> 在长江中下游湖泊群间迁移。", desc_en: "<b>[Foraging]</b> Moving to find food." },
                        { pos: [34.80, 113.50], desc_zh: "<b>[北迁·黄河]</b> 飞越黄河，在三门峡库区停歇。", desc_en: "<b>[Crossing]</b> Flying over the Yellow River." },
                        { pos: [41.00, 113.00], desc_zh: "<b>[北迁·内蒙]</b> 飞越干旱草原，在岱海停歇补水。", desc_en: "<b>[Hydration]</b> Stopover at Inner Mongolia lakes." },
                        { pos: [50.00, 105.00], desc_zh: "<b>[北迁·出境]</b> 抵达贝加尔湖南岸，冰雪初融。", desc_en: "<b>[Border]</b> Reaching Lake Baikal." },
                        { pos: [53.00, 108.00], desc_zh: "<b>[抵达·苔原]</b> 到达西伯利亚繁殖地，快速筑巢。", desc_en: "<b>[Arrival]</b> Reaching Siberian Tundra." },
                        { pos: [54.00, 109.00], desc_zh: "<b>[育雏高峰]</b> 昆虫爆发提供丰富蛋白质。", desc_en: "<b>[Peak Season]</b> Abundant food supply." },
                        { pos: [53.50, 108.50], desc_zh: "<b>[换羽期]</b> 成鸟暂时失去飞行能力。", desc_en: "<b>[Molting]</b> Flightless period." },
                        { pos: [45.00, 116.00], desc_zh: "<b>[南迁·草原]</b> 寒流来袭，经由锡林郭勒南下。", desc_en: "<b>[Southbound]</b> Taking the grassland route." },
                        { pos: [37.00, 116.50], desc_zh: "<b>[南迁·山东]</b> 在黄河故道湿地停歇等待气流。", desc_en: "<b>[Rest]</b> Old Yellow River course." },
                        { pos: [31.00, 117.50], desc_zh: "<b>[南迁·安徽]</b> 抵达升金湖，利用枯水期滩涂。", desc_en: "<b>[Arrival]</b> Reaching Shengjin Lake." },
                        { pos: [29.10, 116.68], desc_zh: "<b>[回归·鄱阳湖]</b> 家族群团聚，万鸟齐鸣。", desc_en: "<b>[Reunion]</b> Wintering at Poyang Lake." }
                    ]
                },
                west: {
                    id: 'goose',
                    name_zh: "西线：斑头雁", name_en: "West: Bar-headed Goose",
                    color: "#56ccf2",
                    sidebar_info_zh: `<strong>习性：</strong> 极强心肺功能，飞越世界屋脊。<br><strong>路线：</strong> 印度(冬) <i class="fas fa-arrows-alt-v"></i> 青海湖(夏)`,
                    sidebar_info_en: `<strong>Habit:</strong> Extreme cardio, over Himalayas.<br><strong>Route:</strong> India <i class="fas fa-arrows-alt-v"></i> Qinghai Lake`,
                    monthlyData: [
                        { pos: [27.20, 88.00], desc_zh: "<b>[越冬·南亚]</b> 在印度与尼泊尔交界低地越冬。", desc_en: "<b>[Wintering]</b> South Asian lowlands." },
                        { pos: [27.20, 88.00], desc_zh: "<b>[集结]</b> 在喜马拉雅南麓盘旋，等待上升气流。", desc_en: "<b>[Waiting]</b> Circling for the monsoon." },
                        { pos: [30.00, 91.00], desc_zh: "<b>[翻越巅峰]</b> 奇迹时刻！8小时内升至海拔8000米。", desc_en: "<b>[Summit]</b> Crossing the Himalayas." },
                        { pos: [34.00, 95.00], desc_zh: "<b>[北迁·高原]</b> 穿越无人区，凭借厚绒抵御严寒。", desc_en: "<b>[Crossing]</b> Flying over no-man's land." },
                        { pos: [36.80, 100.20], desc_zh: "<b>[抵达·青海湖]</b> 利用湖心岛隔绝捕食者开始筑巢。", desc_en: "<b>[Arrival]</b> Qinghai Lake breeding grounds." },
                        { pos: [37.00, 100.00], desc_zh: "<b>[孵化期]</b> 湖中湟鱼回游提供丰富营养。", desc_en: "<b>[Nesting]</b> Building nests on islands." },
                        { pos: [36.90, 100.40], desc_zh: "<b>[育雏期]</b> 雏鸟只能游泳躲避天敌。", desc_en: "<b>[Rearing]</b> Avoiding predators." },
                        { pos: [36.80, 100.20], desc_zh: "<b>[练飞期]</b> 幼鸟羽翼丰满，开始编队飞行。", desc_en: "<b>[Training]</b> Formation flight practice." },
                        { pos: [34.00, 92.00], desc_zh: "<b>[南迁·唐古拉]</b> 经由唐古拉山口向南撤离。", desc_en: "<b>[Departure]</b> Crossing Tanggula Pass." },
                        { pos: [30.00, 85.00], desc_zh: "<b>[南迁·河谷]</b> 在雅鲁藏布江上游休整。", desc_en: "<b>[Rest]</b> Yarlung Tsangpo Valley." },
                        { pos: [28.00, 84.00], desc_zh: "<b>[飞越·干城章嘉]</b> 借助秋季北风高速俯冲越过雪山。", desc_en: "<b>[Descent]</b> Over Kangchenjunga." },
                        { pos: [27.20, 88.00], desc_zh: "<b>[回归·南亚]</b> 在温暖的河谷平原降落。", desc_en: "<b>[Landing]</b> Return to the warmth." }
                    ]
                }
            };

            var map = L.map('map', { scrollWheelZoom: false }).setView([36.0, 104.0], 4);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap, &copy; CARTO'
            }).addTo(map);

            // 历史图层(可清空)
            var historyLayerGroup = L.layerGroup().addTo(map);
            
            let currentTemperatureLayer = null;

            // --- 4. 几何鸟图标 SVG 生成 ---
            function getBirdSVG(type, color) {
                // 丹顶鹤
                const craneShape = `<path d="M20 5 L25 15 L38 12 L22 25 L20 38 L18 25 L2 12 L15 15 Z" fill="${color}" stroke="white" stroke-width="1.5" stroke-linejoin="round"/><path d="M20 5 L20 25" stroke="white" stroke-width="1" opacity="0.5"/>`;
                // 小天鹅
                const swanShape = `<path d="M20 2 L28 15 L38 8 L25 22 L20 35 L15 22 L2 8 L12 15 Z" fill="${color}" stroke="white" stroke-width="1.5" stroke-linejoin="round"/><path d="M20 2 L20 22" stroke="white" stroke-width="1" opacity="0.5"/>`;
                // 斑头雁
                const gooseShape = `<path d="M20 0 L26 18 L36 24 L20 28 L4 24 L14 18 Z" fill="${color}" stroke="white" stroke-width="1.5" stroke-linejoin="round"/><path d="M20 0 L20 28" stroke="white" stroke-width="1" opacity="0.5"/>`;

                const shapes = { 'crane': craneShape, 'swan': swanShape, 'goose': gooseShape };

                return `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" style="overflow:visible;">
                            <filter id="ds-${type}"><feDropShadow dx="0" dy="3" stdDeviation="2" flood-color="rgba(0,0,0,0.3)"/></filter>
                            <g filter="url(#ds-${type})">${shapes[type] || shapes['crane']}</g>
                        </svg>`;
            }

            function renderSidebar() {
                const container = document.getElementById('sidebar-content');
                const title = currentLang === 'zh' ? '代表种群档案' : 'Species Archive';
                let html = `<div class="sidebar-title">${title}</div>`;
                
                Object.values(birdData).forEach(bird => {
                    const name = currentLang === 'zh' ? bird.name_zh : bird.name_en;
                    const info = currentLang === 'zh' ? bird.sidebar_info_zh : bird.sidebar_info_en;
                    html += `<div class="bird-mini-card" style="border-left-color: ${bird.color};"><div class="bird-mini-title" style="color:${bird.color};">${name}</div><div class="bird-mini-text">${info}</div></div>`;
                });

                const legendTitle = currentLang === 'zh' ? '图例说明' : 'Legend';
                const legendContent = currentLang === 'zh' 
                    ? `<div class="legend-item"><span class="legend-dot" style="background:#3388ff;"></span>越冬地</div><div class="legend-item"><span class="legend-dot" style="background:#ff3333;"></span>繁殖地</div><div class="legend-item"><span class="legend-dot" style="background:#ffcc00;"></span>途经地</div><div class="legend-item"></div><div class="legend-item"><span class="legend-line" style="background:#666;"></span>北迁 (春)</div><div class="legend-item"><span class="legend-line" style="background:#666; border-top: 2px dashed #666; background:none; height:0;"></span>南迁 (秋)</div>`
                    : `<div class="legend-item"><span class="legend-dot" style="background:#3388ff;"></span>Wintering</div><div class="legend-item"><span class="legend-dot" style="background:#ff3333;"></span>Breeding</div><div class="legend-item"><span class="legend-dot" style="background:#ffcc00;"></span>Stopover</div><div class="legend-item"></div><div class="legend-item"><span class="legend-line" style="background:#666;"></span>Spring</div><div class="legend-item"><span class="legend-line" style="background:#666; border-top: 2px dashed #666; background:none; height:0;"></span>Autumn</div>`;

                html += `<div class="sidebar-title mt-3" style="padding-top:5px;">${legendTitle}</div><div class="legend-grid">${legendContent}</div>`;
                container.innerHTML = html;
            }

            // --- 5. [核心修正] 更新地图：鸟先飞，线后画 ---
            function updateBirdMigration(month) {
                // 1. 清除上一次未完成的画线定时器，防止快速切换时线条错乱
                routeDrawTimeouts.forEach(t => clearTimeout(t));
                routeDrawTimeouts = [];

                historyLayerGroup.clearLayers();
                const monthNamesEn = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

                Object.values(birdData).forEach(bird => {
                    const turfPoints = bird.monthlyData.map(d => [d.pos[1], d.pos[0]]);
                    
                    // --- Part A: 绘制 "上个月及其之前" 的历史轨迹 (Stable History) ---
                    
                    // [1. 历史点] 绘制 0 -> month-1 (不含当前月)
                    for (let i = 0; i < month - 1; i++) {
                        const historyPos = bird.monthlyData[i].pos;
                        const historyIcon = L.divIcon({
                            className: '', 
                            html: `<div class="history-dot" style="--bird-color:${bird.color};"></div>`,
                            iconSize: [8, 8], iconAnchor: [4, 4]
                        });
                        L.marker(historyPos, { icon: historyIcon, interactive: false, zIndexOffset: 500 }).addTo(historyLayerGroup);
                    }

                    // [2. 历史线] 绘制 0 -> month-1 (修正处：只画到上个月)
                    if (month > 2) { // 至少要有3个月的数据(0,1,2)才能画出 0->1 的历史线
                        // 核心修正：slice(0, month - 1)
                        let stablePathPoints = turfPoints.slice(0, month - 1); 
                        
                        // 简单去重
                        let cleanStablePath = stablePathPoints.filter((pt, i) => i===0 || !(pt[0]===stablePathPoints[i-1][0] && pt[1]===stablePathPoints[i-1][1]));
                        
                        if (cleanStablePath.length >= 2) {
                            const line = turf.lineString(cleanStablePath);
                            const curved = turf.bezierSpline(line, {resolution: 10000, sharpness: 0.5});
                            // 立即添加到地图
                            L.geoJSON(curved, { 
                                style: { color: bird.color, weight: 2, opacity: 0.6, dashArray: month>8?'5,5':null } 
                            }).addTo(historyLayerGroup);
                        }
                    }

                    // --- Part B: 更新候鸟位置 (Bird Animation) ---
                    
                    const monthData = bird.monthlyData[month - 1];
                    const currentPos = monthData.pos; 
                    const currentDesc = currentLang === 'zh' ? monthData.desc_zh : monthData.desc_en;
                    const birdName = currentLang === 'zh' ? bird.name_zh : bird.name_en;
                    const monthLabel = currentLang === 'zh' ? `${month}月` : monthNamesEn[month-1];

                    // 计算朝向
                    let bearing = 0;
                    if (month > 1) {
                        const prevPos = bird.monthlyData[month-2].pos;
                        const start = turf.point([prevPos[1], prevPos[0]]);
                        const end = turf.point([currentPos[1], currentPos[0]]);
                        bearing = turf.bearing(start, end);
                    }

                    // 处理 Marker
                    if (birdMarkers[bird.id]) {
                        const marker = birdMarkers[bird.id];
                        // 触发 CSS transition (1.5s)
                        marker.setLatLng(currentPos);
                        
                        const tooltipHtml = `<div style="border-bottom: 2px solid ${bird.color}; padding-bottom:5px; margin-bottom:5px; font-weight:bold; color:${bird.color}">
                            ${birdName} <span style="font-size:0.7em; color:#888; background:#eee; padding:2px 6px; border-radius:10px;">${monthLabel}</span>
                         </div>
                         <div style="font-size:0.85rem;">${currentDesc}</div>`;
                        marker.setTooltipContent(tooltipHtml);

                        const iconDiv = marker.getElement().querySelector('.geo-bird-icon');
                        if (iconDiv) iconDiv.style.transform = `rotate(${bearing}deg)`;

                    } else {
                        // 首次创建
                        const svgHtml = getBirdSVG(bird.id, bird.color);
                        const birdIcon = L.divIcon({
                            className: 'bird-icon-wrapper', 
                            html: `<div class="geo-bird-icon" style="transform: rotate(${bearing}deg);">${svgHtml}</div>`, 
                            iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -25]
                        });
                        const newMarker = L.marker(currentPos, { icon: birdIcon, zIndexOffset: 1000 })
                            .bindTooltip(
                                `<div style="border-bottom: 2px solid ${bird.color}; padding-bottom:5px; margin-bottom:5px; font-weight:bold; color:${bird.color}">
                                    ${birdName} <span style="font-size:0.7em; color:#888; background:#eee; padding:2px 6px; border-radius:10px;">${monthLabel}</span>
                                 </div>
                                 <div style="font-size:0.85rem;">${currentDesc}</div>`, 
                                { direction: 'top', sticky: true, className: 'bird-status-tooltip', offset: [0, -20] }
                            ).addTo(map); 
                        birdMarkers[bird.id] = newMarker;
                    }

                    // --- Part C: 延迟绘制最新一段路线 (Delayed Line) ---
                    if (month > 1) {
                        // 设置 1500ms 的延时，等鸟飞到了再画线
                        const timeoutId = setTimeout(() => {
                            // 绘制整条线 (0 -> month)，覆盖之前的历史线，形成完整的路径
                            // 或者你也可以只画 month-1 到 month 这一段，但 turf 计算贝塞尔曲线时，分段画可能会不平滑
                            // 所以最佳策略是：动画结束后，用包含最新点的全路径覆盖一次
                            
                            let fullPathPoints = turfPoints.slice(0, month); // 这次是 slice(0, month)
                            let cleanFullPath = fullPathPoints.filter((pt, i) => i===0 || !(pt[0]===fullPathPoints[i-1][0] && pt[1]===fullPathPoints[i-1][1]));
                            
                            if (cleanFullPath.length >= 2) {
                                const line = turf.lineString(cleanFullPath);
                                const curved = turf.bezierSpline(line, {resolution: 10000, sharpness: 0.5});
                                
                                // 这里可以加一个小 trick：先画一条透明度渐变的线，或者直接添加
                                L.geoJSON(curved, { 
                                    style: { color: bird.color, weight: 2, opacity: 0.6, dashArray: month>8?'5,5':null } 
                                }).addTo(historyLayerGroup);
                            }
                        }, 1500); // 必须与 CSS transition 时间一致
                        
                        routeDrawTimeouts.push(timeoutId);
                    }
                });
            }

            function updateTemperatureLayer(monthIndex) {
                currentMonth = monthIndex;
                updateMonthLabel();
                const monthStr = monthIndex.toString().padStart(2, '0');
                const newTileUrl = `${TILE_BASE_URL}${monthStr}/{z}/{x}/{y}.png`; 
                const nextLayer = L.tileLayer(newTileUrl, { minZoom: 3, maxZoom: 10, opacity: 0, tms: false, zIndex: 50 });
                nextLayer.addTo(map);
                setTimeout(() => { if(nextLayer.getContainer()) nextLayer.setOpacity(1); }, 50);
                if (currentTemperatureLayer) {
                    const oldLayer = currentTemperatureLayer;
                    setTimeout(() => { map.removeLayer(oldLayer); }, 600);
                }
                currentTemperatureLayer = nextLayer;
                updateBirdMigration(monthIndex);
            }

            function updateMonthLabel() {
                const monthNamesEn = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                const label = document.getElementById('current-month-label');
                if (currentLang === 'zh') {
                    label.textContent = `${currentMonth}月`;
                } else {
                    label.textContent = monthNamesEn[currentMonth - 1];
                }
            }

            let isPlaying = false; let playInterval = null;
            const slider = document.getElementById('month-slider');
            
            function togglePlay() {
                if (isPlaying) {
                    clearInterval(playInterval);
                    document.getElementById('play-btn').innerHTML = '<i class="fas fa-play"></i>';
                    isPlaying = false;
                } else {
                    document.getElementById('play-btn').innerHTML = '<i class="fas fa-pause"></i>';
                    isPlaying = true;
                    playInterval = setInterval(() => {
                        let nextVal = parseInt(slider.value) + 1;
                        if (nextVal > 12) nextVal = 1;
                        slider.value = nextVal;
                        updateTemperatureLayer(nextVal);
                    }, 1500);
                }
            }

            slider.addEventListener('input', function() { 
                if (isPlaying) togglePlay(); 
                updateTemperatureLayer(parseInt(this.value)); 
            });

            // --- 初始化 ---
            updateTemperatureLayer(1);
            renderSidebar(); 

        </script>
    </body>
</html>