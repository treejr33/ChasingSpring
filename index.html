<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="候鸟逐春 - 中国候鸟迁徙与气温变化可视化" />
        <meta name="author" content="" />
        <title>候鸟逐春 - 气温与迁徙可视化</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <link href="https://fonts.googleapis.com/css?family=Varela+Round" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet" />
        
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        
        <link href="css/styles.css" rel="stylesheet" />

        <style>
            /* --- 地图容器 --- */
            #map { 
                width: 100%; 
                height: 650px; 
                background-color: #ffffff; 
                border: none; border-radius: 0; box-shadow: none;
            }
            
            /* --- 基础 UI 调整 --- */
            header.masthead { background: #222 !important; background-image: none !important; }
            .projects-section { background-image: none !important; }
            .background-icon-element { display: none !important; }
            
            /* --- 滑块样式 --- */
            .slider-container-bottom {
                background: white; padding: 15px 20px; border-radius: 0.5rem;
                margin-top: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                display: flex; align-items: center; justify-content: center;
            }
            .current-month-number {
                font-size: 1.4rem; font-weight: 800; color: #64a19d;
                width: 80px; text-align: center; margin-right: 15px;
            }
            #month-slider { flex-grow: 1; max-width: 85%; cursor: pointer; }

            /* --- 悬浮图例样式 --- */
            .temp-legend-overlay {
                position: absolute; bottom: 20px; right: 20px; z-index: 1000;
                background: rgba(255, 255, 255, 0.9); padding: 12px; border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2); text-align: left; display: flex; flex-direction: column;
            }
            .temp-legend-overlay h6 {
                margin: 0 0 10px 0; font-size: 0.85rem; color: #333; font-weight: bold; text-align: center;
            }
            .legend-content { display: flex; align-items: center; }
            #color-ramp {
                width: 15px; height: 120px;
                background: linear-gradient(to top, #0000FF 0%, #FFFF00 50%, #FF0000 100%);
                margin-right: 10px; border: 1px solid #ccc; border-radius: 2px;
            }
            .legend-labels {
                height: 120px; display: flex; flex-direction: column;
                justify-content: space-between; font-size: 0.75rem; color: #555; line-height: 1;
            }

            /* --- 播放按钮 --- */
            .play-control-btn {
                position: absolute; bottom: 20px; left: 20px; z-index: 1000;
                width: 50px; height: 50px; border-radius: 50%;
                background-color: white; border: none;
                box-shadow: 0 4px 10px rgba(0,0,0,0.3); color: #64a19d; font-size: 20px;
                cursor: pointer; display: flex; align-items: center; justify-content: center;
                transition: all 0.2s ease;
            }
            .play-control-btn:hover { background-color: #f8f9fa; transform: scale(1.1); }
            
            /* --- 鸟类图例 --- */
            .legend-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
            .legend-line { width: 20px; height: 3px; display: inline-block; margin-right: 5px; vertical-align: middle; }
        </style>
    </head>
    <body id="page-top">
        <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
            <div class="container px-4 px-lg-5 p-0">
                <a class="navbar-brand" href="#page-top">候鸟逐春</a>
                <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="#about">迁徙奥秘</a></li>
                        <li class="nav-item"><a class="nav-link" href="#map-section">迁徙地图</a></li>
                        <li class="nav-item"><a class="nav-link" href="#contact">加入我们</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <header class="masthead">
            <div class="container px-4 px-lg-5 d-flex h-100 align-items-center justify-content-center">
                <div class="d-flex justify-content-center">
                    <div class="text-center">
                        <h1 class="mx-auto my-0 text-uppercase">候鸟逐春</h1>
                        <h2 class="text-white-50 mx-auto mt-2 mb-5">探索中国境内候鸟迁徙与季节温度变化的共舞</h2>
                        <a class="btn btn-primary" href="#map-section">开启旅程</a>
                    </div>
                </div>
            </div>
        </header>

        <section class="about-section text-center" id="about">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="text-white mb-4">逐温而行：生命的节律</h2>
                        <p class="text-white-50">
                            候鸟的迁徙是一场对能量与时机的精准计算。为了生存，它们不仅要追随 <strong>5°C - 10°C</strong> 的舒适温区，还要避开拥挤的旧路线，寻找新的食物补给点。
                            <br><br>
                            本项目模拟了候鸟的真实迁徙逻辑：<strong>位置随月份推进，路线随飞行延伸</strong>，直观展示了它们如何利用季节风向和气温变化，在中国广袤的土地上画出生命的闭环。
                        </p>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="projects-section bg-light" id="map-section">
            <div class="container px-4 px-lg-5">
                <div class="row mb-4">
                    <div class="col-12 text-center">
                        <h2 class="text-black">候鸟迁徙全周期模拟</h2>
                        <p class="text-black-50">点击播放，观察候鸟如何领航路线生长</p>
                    </div>
                </div>

                <div class="row gx-0 mb-4 mb-lg-5">
                    <div class="col-xl-8 col-lg-7 p-0">
                        <div style="position: relative;">
                            <div id="map"></div>

                            <button id="play-btn" class="play-control-btn" onclick="togglePlay()" title="播放/暂停">
                                <i class="fas fa-play"></i>
                            </button>

                            <div class="temp-legend-overlay">
                                <h6>气温 (°C)</h6>
                                <div class="legend-content">
                                    <div id="color-ramp"></div>
                                    <div class="legend-labels">
                                        <span>35</span><span>20</span><span>5</span><span>-10</span><span>-25</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="slider-container-bottom">
                            <span id="current-month-label" class="current-month-number">1月</span>
                            <input type="range" id="month-slider" min="1" max="12" value="1" step="1">
                        </div>
                    </div>
                    
                    <div class="col-xl-4 col-lg-5">
                        <div class="featured-text text-center text-lg-left" style="padding-left: 30px; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                            
                            <h5 class="text-black mb-3 fw-bold">图例说明</h5>
                            
                            <div class="mb-4">
                                <div class="mb-2"><span class="legend-dot" style="background:#3388ff;"></span> <strong>越冬地</strong> <small class="text-muted">(起点)</small></div>
                                <div class="mb-2"><span class="legend-dot" style="background:#ff3333;"></span> <strong>繁殖地</strong> <small class="text-muted">(终点)</small></div>
                                <div class="mb-2"><span class="legend-dot" style="background:#ffcc00;"></span> <strong>当前位置</strong> <small class="text-muted">(领航点)</small></div>
                                <div class="mb-2"><span class="legend-line" style="background:#666;"></span> <strong>北迁 (春)</strong> <small class="text-muted">实线</small></div>
                                <div class="mb-2"><span class="legend-line" style="background:#666; border-top: 2px dashed #666; background:none; height:0;"></span> <strong>南迁 (秋)</strong> <small class="text-muted">虚线</small></div>
                            </div>

                            <hr>

                            <h5 class="text-black mb-2 fw-bold">迁徙路线设计</h5>
                            <ul class="text-black-50 small" style="padding-left: 1.2rem; text-align: left;">
                                <li class="mb-3">
                                    <strong style="color:#FF7F50">东线 (丹顶鹤):</strong><br>
                                    春季沿海北上，秋季略偏内陆避风南下，形成狭长回路。
                                </li>
                                <li class="mb-3">
                                    <strong style="color:#20c997">中线 (小天鹅):</strong><br>
                                    跨越长江黄河，在大草原上迂回，南北路线明显分离。
                                </li>
                                <li class="mb-3">
                                    <strong style="color:#56ccf2">西线 (斑头雁):</strong><br>
                                    围绕青藏高原边缘飞行，利用不同山口穿越喜马拉雅。
                                </li>
                            </ul>

                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="signup-section" id="contact">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5">
                    <div class="col-md-10 col-lg-8 mx-auto text-center">
                        <i class="far fa-paper-plane fa-2x mb-2 text-white"></i>
                        <h2 class="text-white mb-5">关注候鸟保护计划</h2>
                        <form class="form-signup" id="contactForm">
                            <div class="row input-group-newsletter">
                                <div class="col"><input class="form-control" id="emailAddress" type="email" placeholder="输入您的邮箱..." /></div>
                                <div class="col-auto"><button class="btn btn-primary disabled" id="submitButton" type="submit">订阅</button></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer bg-black small text-center text-white-50">
            <div class="container px-4 px-lg-5 p-0">Copyright &copy; 候鸟逐春项目组 2025</div>
        </footer>
        
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="js/scripts.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

        <script>
            // --- 1. 初始化地图 ---
            const TILE_BASE_URL = './tiles/2024-'; 
            var map = L.map('map', { scrollWheelZoom: false }).setView([36.0, 104.0], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19, attribution: '© OpenStreetMap', zIndex: 0 
            }).addTo(map);

            var birdsLayerGroup = L.layerGroup().addTo(map);
            let currentTemperatureLayer = null;

            // --- 2. 候鸟精细化数据 (回路设计：坐标微调以防重合) ---
            // 结构：12个月的坐标点。确保春季(3-5)和秋季(9-11)的经度/纬度有偏差。
            const birdData = {
                east: {
                    name: "丹顶鹤",
                    color: "#FF7F50", // 珊瑚红
                    // 12个月位置 [Lat, Lng]
                    monthlyPos: [
                        [33.38, 120.13], // 1月: 盐城 (起点)
                        [33.38, 120.13], // 2月: 盐城
                        [36.50, 119.50], // 3月: 山东日照 (北上偏东/沿海)
                        [40.00, 120.50], // 4月: 渤海湾北岸
                        [47.20, 124.25], // 5月: 扎龙 (抵达)
                        [47.20, 124.25], // 6月: 扎龙
                        [47.20, 124.25], // 7月: 扎龙
                        [47.20, 124.25], // 8月: 扎龙
                        [44.50, 122.00], // 9月: 内蒙通辽 (南下偏西/内陆)
                        [38.00, 117.50], // 10月: 沧州/黄骅
                        [34.50, 118.50], // 11月: 连云港内陆侧
                        [33.38, 120.13]  // 12月: 盐城 (闭环)
                    ]
                },
                mid: {
                    name: "小天鹅",
                    color: "#20c997", // 海藻绿
                    monthlyPos: [
                        [29.10, 116.68], // 1月: 鄱阳湖
                        [29.10, 116.68], // 2月: 鄱阳湖
                        [34.00, 114.00], // 3月: 郑州附近 (北上直线)
                        [41.00, 113.00], // 4月: 乌兰察布
                        [50.00, 105.00], // 5月: 贝加尔湖南岸 (抵达)
                        [50.00, 105.00], // 6月: 繁殖
                        [50.00, 105.00], // 7月: 繁殖
                        [50.00, 105.00], // 8月: 繁殖
                        [45.00, 116.00], // 9月: 锡林郭勒 (南下大弯道-偏东)
                        [37.00, 116.50], // 10月: 山东德州
                        [31.00, 117.50], // 11月: 安徽池州
                        [29.10, 116.68]  // 12月: 鄱阳湖
                    ]
                },
                west: {
                    name: "斑头雁",
                    color: "#56ccf2", // 天际蓝
                    monthlyPos: [
                        [27.20, 88.00],  // 1月: 印度/锡金边境
                        [27.20, 88.00],  // 2月: 越冬
                        [30.00, 91.00],  // 3月: 拉萨 (北上偏东路线)
                        [34.00, 95.00],  // 4月: 昆仑山口东
                        [36.80, 100.20], // 5月: 青海湖
                        [36.80, 100.20], // 6月: 青海湖
                        [36.80, 100.20], // 7月: 青海湖
                        [36.80, 100.20], // 8月: 青海湖
                        [34.00, 92.00],  // 9月: 唐古拉山口 (南下偏西路线)
                        [30.00, 85.00],  // 10月: 昂拉仁错
                        [28.00, 84.00],  // 11月: 尼泊尔安纳普尔纳
                        [27.20, 88.00]   // 12月: 回到起点
                    ]
                }
            };

            // --- 3. 更新气温图层 ---
            function updateTemperatureLayer(monthIndex) {
                const monthStr = monthIndex.toString().padStart(2, '0');
                const newTileUrl = `${TILE_BASE_URL}${monthStr}/{z}/{x}/{y}.png`; 
                
                const nextLayer = L.tileLayer(newTileUrl, {
                    minZoom: 3, maxZoom: 10, opacity: 0, tms: false, zIndex: 50
                });
                nextLayer.addTo(map);

                if (nextLayer.getContainer()) {
                    nextLayer.getContainer().style.transition = 'opacity 0.5s linear';
                }
                setTimeout(() => { nextLayer.setOpacity(0.7); }, 20);

                if (currentTemperatureLayer) {
                    const oldLayer = currentTemperatureLayer;
                    if (oldLayer.getContainer()) oldLayer.getContainer().style.transition = 'opacity 0.5s linear';
                    oldLayer.setOpacity(0);
                    setTimeout(() => { map.removeLayer(oldLayer); }, 500);
                }

                currentTemperatureLayer = nextLayer;
                document.getElementById('current-month-label').textContent = `${monthIndex}月`;

                updateBirdMigration(monthIndex);
            }

            // --- 4. 核心：动态生长路径绘制 ---
            function updateBirdMigration(month) {
                birdsLayerGroup.clearLayers(); 

                Object.values(birdData).forEach(bird => {
                    const points = bird.monthlyPos;
                    // 翻转坐标为 [Lng, Lat] 用于 Turf
                    const turfPoints = points.map(p => [p[1], p[0]]);
                    
                    // --- A. 绘制当前位置鸟 ---
                    // 始终显示当前月份的鸟位置
                    const currentPos = points[month - 1]; 
                    let markerColor = bird.color;
                    let markerRadius = 6;

                    // 根据月份定义状态 (图标颜色)
                    if (month <= 2 || month >= 12) { // 越冬
                        markerColor = "#3388ff"; 
                    } else if (month >= 5 && month <= 8) { // 繁殖
                        markerColor = "#ff3333"; 
                    } else { // 迁徙途经 (3,4, 9,10,11)
                        markerColor = "#ffcc00"; 
                        markerRadius = 5; 
                    }

                    // 绘制“领航鸟”
                    L.circleMarker(currentPos, {
                        radius: markerRadius,
                        fillColor: markerColor,
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 1
                    }).bindPopup(`<b>${bird.name}</b>`).addTo(birdsLayerGroup);


                    // --- B. 路径生长逻辑 (Path Growing) ---
                    
                    // 1. 春季北上实线 (3月开始生长)
                    if (month >= 3) {
                        // 截取点：从1月(index 0) 到 当前月(或5月截止)
                        // 这里的逻辑是：只要没到南迁(9月)，实线就跟着月份长
                        // 到了9月后，实线固定在5月的位置(繁殖地)，不再动
                        let endIndex = Math.min(month - 1, 4); // 4是5月(index)
                        
                        // 如果还在2月，endIndex=1，刚好画出一点头。
                        // 我们构建一个 path segment
                        let pathSegment = turfPoints.slice(1, endIndex + 1); // 从2月位置开始画
                        
                        // 必须加上起点(1月)才能连线
                        pathSegment.unshift(turfPoints[0]);

                        if (pathSegment.length >= 2) {
                            const line = turf.lineString(pathSegment);
                            // 贝塞尔曲线平滑
                            const curved = turf.bezierSpline(line, {resolution: 10000, sharpness: 0.5});
                            
                            L.geoJSON(curved, {
                                style: {
                                    color: bird.color,
                                    weight: 3,
                                    opacity: 0.8,
                                    lineCap: 'round' // 实线
                                }
                            }).addTo(birdsLayerGroup);
                        }
                    }

                    // 2. 秋季南下虚线 (9月开始生长)
                    if (month >= 9) {
                        // 截取点：从8月(index 7) 到 当前月
                        let endIndex = month - 1;
                        let pathSegment = turfPoints.slice(7, endIndex + 1);
                        
                        // 加上8月的起点
                        // 注意：这里的起点其实是繁殖地位置
                        // 为了视觉连续，我们取index 7 (8月位置)作为起始
                        // 我们的 monthlyPos[7] 是繁殖地
                        
                        // pathSegment 已经包含了 slice(7...) 即 [8月, 9月...]
                        // 所以不需要 unshift 额外的点，slice(7, 9) 就是 [8月点, 9月点] 两个点

                        if (pathSegment.length >= 2) {
                            const line = turf.lineString(pathSegment);
                            const curved = turf.bezierSpline(line, {resolution: 10000, sharpness: 0.5});
                            
                            L.geoJSON(curved, {
                                style: {
                                    color: bird.color,
                                    weight: 3,
                                    opacity: 0.8,
                                    dashArray: '5, 8', // 虚线
                                    lineCap: 'butt'
                                }
                            }).addTo(birdsLayerGroup);
                        }
                    }

                    // 3. 辅助常驻点 (起点/终点)
                    // 始终显示越冬地起点
                    L.circleMarker(points[0], { radius: 3, color: bird.color, fillColor: "#3388ff", fillOpacity: 0.5, weight: 0 }).addTo(birdsLayerGroup);
                    // 5月后显示繁殖地终点
                    if(month >= 5) {
                        L.circleMarker(points[4], { radius: 3, color: bird.color, fillColor: "#ff3333", fillOpacity: 0.5, weight: 0 }).addTo(birdsLayerGroup);
                    }

                });
            }

            // --- 5. 播放控制 ---
            const slider = document.getElementById('month-slider');
            updateTemperatureLayer(parseInt(slider.value)); 

            let isPlaying = false;
            let playInterval = null;

            function togglePlay() {
                const btn = document.getElementById('play-btn');
                if (isPlaying) { stopPlay(); } else { startPlay(); }
            }

            function startPlay() {
                isPlaying = true;
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-pause"></i>'; 
                playInterval = setInterval(() => {
                    let currentVal = parseInt(slider.value);
                    let nextVal = currentVal + 1;
                    if (nextVal > 12) nextVal = 1;
                    slider.value = nextVal;
                    updateTemperatureLayer(nextVal);
                }, 1200); // 稍慢一点(1.2s)让眼睛能跟上路线生长
            }

            function stopPlay() {
                isPlaying = false;
                clearInterval(playInterval);
                document.getElementById('play-btn').innerHTML = '<i class="fas fa-play"></i>'; 
            }

            slider.addEventListener('input', function() {
                if (isPlaying) stopPlay();
                updateTemperatureLayer(parseInt(this.value));
            });
            
            window.addEventListener('resize', function() { map.invalidateSize(); });
        </script>
    </body>
</html>