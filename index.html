<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="Spring Chasers - Bird Migration Visualization" />
        <title>候鸟逐春 Chasing Spring</title>
        
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Noto+Serif+SC:wght@300;700&display=swap" rel="stylesheet">
        
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <link href="css/styles.css" rel="stylesheet" />
        <link href="css/custom.css" rel="stylesheet" />

        <style>
            .legend-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; flex-shrink: 0; }
            .legend-line { display: inline-block; width: 15px; height: 2px; margin-right: 6px; vertical-align: middle; flex-shrink: 0; }
        </style>
    </head>
    <body id="page-top">
        
        <button class="lang-switch-btn" onclick="toggleLanguage()">
            <i class="fas fa-globe"></i> <span id="lang-btn-text">EN</span>
        </button>

        <div class="video-background-holder">
            <div class="video-overlay"></div>
            <video autoplay muted loop playsinline id="bg-video">
                <source src="assets/bg-video.mp4" type="video/mp4">
            </video>
        </div>

        <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
            <div class="container px-4 px-lg-5 p-0">
                <a class="navbar-brand text-white" href="#page-top">
                    <span class="lang-zh">候鸟逐春</span><span class="lang-en">SPRING CHASERS</span>
                </a>
                <button class="navbar-toggler navbar-toggler-right bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link text-white-50 fw-bold" href="#about">
                            <span class="lang-zh">迁徙奥秘</span><span class="lang-en">The Journey</span>
                        </a></li>
                        <li class="nav-item"><a class="nav-link text-white-50 fw-bold" href="#map-section">
                            <span class="lang-zh">迁徙地图</span><span class="lang-en">Migration Map</span>
                        </a></li>
                        <li class="nav-item"><a class="nav-link text-white-50 fw-bold" href="#contact">
                            <span class="lang-zh">加入我们</span><span class="lang-en">Get Involved</span>
                        </a></li>
                    </ul>
                </div>
            </div>
        </nav>
        
        <header class="masthead">
            <div class="hero-box">
                <h1 class="hero-title">
                    <span class="lang-zh">候鸟逐春</span>
                    <span class="lang-en">SPRING CHASERS</span>
                </h1>
                <div class="hero-subtitle">
                    <span class="lang-zh">中国候鸟迁徙与气温变化可视化</span>
                    <span class="lang-en">Tracking the Warmth: A Migration Visualization</span>
                </div>
                <div>
                    <a class="btn btn-hero" href="#map-section">
                        <span class="lang-zh">开启旅程</span><span class="lang-en">Explore Map</span>
                    </a>
                </div>
            </div>
            <div class="tm-next" style="position:absolute; bottom:40px;">
                <a href="#about"><i class="fas fa-caret-down tm-down-arrow"></i></a>
            </div> 
        </header>

        <section class="about-section text-center" id="about">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-lg-8">
                        <h2 class="text-white mb-4 brand-font">
                            <span class="lang-zh">逐温而行：生命的节律</span>
                            <span class="lang-en">Chasing Isotherms: The Rhythm of Life</span>
                        </h2>
                        <p class="text-white-50 fs-5">
                            <span class="lang-zh">候鸟的迁徙是一场对能量与时机的精准计算。为了生存，它们不仅要追随 <strong>5°C - 10°C</strong> 的舒适温区，还要避开拥挤的旧路线，寻找新的食物补给点。本项目还原了三大候鸟种群的真实迁徙策略。</span>
                            <span class="lang-en">Migration is a delicate balance of energy and timing. Driven by survival, these travelers don't just fly north—they follow the <strong>5°C - 10°C</strong> isotherm, riding the invisible wave of spring. This project visualizes the authentic strategies of three major bird populations.</span>
                        </p>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="projects-section" id="map-section">
            
            <div class="section-bg-layer">
                <div id="bg-img-east" class="bg-bird-img active" 
                     style="background-image: url('assets/img/crane.png');"></div>
                <div id="bg-img-mid" class="bg-bird-img active" 
                     style="background-image: url('assets/img/swan.png');"></div>
                <div id="bg-img-west" class="bg-bird-img active" 
                     style="background-image: url('assets/img/goose.png');"></div>
            </div>

            <div class="container px-4 px-lg-5" style="position: relative; z-index: 5;">
                <div class="text-center mb-5">
                    <h2 class="text-black brand-font">
                        <span class="lang-zh">候鸟迁徙全周期模拟</span>
                        <span class="lang-en">Annual Cycle Simulation</span>
                    </h2>
                    <p class="text-muted">
                        <span class="lang-zh">点击播放，<strong style="color:#64a19d;">悬停几何图标</strong> 查看实时状态，<strong style="color:#64a19d;">点击右上角</strong> 筛选线路与热力图</span>
                        <span class="lang-en">Press Play to start. <strong style="color:#64a19d;">Hover</strong> over birds for status. Filter routes via <strong style="color:#64a19d;">Top-Right</strong> control.</span>
                    </p>
                </div>

                <div class="row gx-0 mb-5">
                    <div class="col-xl-9 col-lg-9 p-0 position-relative">
                        <div id="map"></div>

                        <div class="sidebar-wrapper">
                            <div class="sidebar-trigger-btn" title="查看详细信息"><i class="fas fa-info"></i></div>
                            <div class="sidebar-panel">
                                <div class="sidebar-content-inner" id="sidebar-content"></div>
                            </div>
                        </div>

                        <button id="play-btn" class="play-control-btn" onclick="togglePlay()"><i class="fas fa-play"></i></button>

                        <div style="position: absolute; bottom: 30px; right: 30px; z-index: 1000; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px; display:flex; align-items:center;">
                            <div style="width:10px; height:80px; background:linear-gradient(to top, #0000FF, #FFFF00, #FF0000); margin-right:10px;"></div>
                            <div style="height:80px; display:flex; flex-direction:column; justify-content:space-between; font-size:0.7rem; font-weight:bold;">
                                <span>35°C</span><span>5°C</span><span>-25°C</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-lg-3 d-none d-lg-block"></div>
                    
                    <div class="col-12">
                        <div class="slider-container-bottom">
                            <span id="current-month-label" style="font-size: 1.5rem; font-weight: 800; color: #2c3e50; width: 100px; text-align: center;">1月</span>
                            <input type="range" id="month-slider" min="1" max="12" value="1" step="1" style="flex-grow: 1;">
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="signup-section" id="contact">
            <div class="container px-4 px-lg-5 text-center">
                <i class="far fa-paper-plane fa-2x mb-4 text-white"></i>
                <h2 class="text-white mb-4 brand-font">
                    <span class="lang-zh">关注候鸟保护计划</span>
                    <span class="lang-en">Protect the Migratory Birds</span>
                </h2>
                <form class="col-md-6 mx-auto d-flex">
                    <input class="form-control me-2" type="email" placeholder="Email..." />
                    <button class="btn btn-primary" type="button">
                        <span class="lang-zh">订阅</span><span class="lang-en">Subscribe</span>
                    </button>
                </form>
            </div>
        </section>

        <footer class="footer bg-black small text-center text-white-50 py-4">
            <div class="container">Copyright &copy; Spring Chasers 2025 | Tiles &copy; CARTO & OSM</div>
        </footer>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
        <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

        <script>
            // --- 全局变量 ---
            let currentLang = 'zh'; 
            let currentMonth = 1;
            const TILE_BASE_URL = './tiles/2024-'; 
            
            // 存储候鸟 Marker 实例
            const birdMarkers = {}; 
            // 存储绘制路线的定时器，用于清除未完成的动画
            let routeDrawTimeouts = [];

            // --- 热力图数据与变量 ---
            const heatMapPoints = [
                [29.11, 116.63, 1.0], // 鄱阳湖 (关键越冬地)
                [28.90, 112.90, 0.9], // 洞庭湖
                [47.20, 124.25, 1.0], // 扎龙湿地 (丹顶鹤繁殖地)
                [36.80, 100.20, 1.0], // 青海湖 (斑头雁繁殖地)
                [37.75, 118.95, 0.8], // 黄河三角洲 (中转站)
                [33.38, 120.13, 0.9], // 盐城珍禽保护区
                [31.50, 121.90, 0.7], // 崇明东滩
                [26.85, 104.28, 0.8], // 贵州草海 (黑颈鹤)
                [41.12, 121.12, 0.6], // 辽河口
                [53.00, 108.00, 0.6], // 贝加尔湖周边
                [34.80, 113.50, 0.5], // 三门峡
                [30.20, 117.40, 0.7], // 升金湖
                [19.00, 109.50, 0.5], // 海南部分湿地
                [24.00, 120.50, 0.4],  // 台湾曾文溪口 (黑面琵鹭)
                [27.20, 88.00, 1.0],  // [新增] 斑头雁越冬地 (南亚低地/印度)
                [29.65, 91.13, 0.8],  // [可选] 拉萨河谷/雅鲁藏布江 (关键停歇地)
                [27.20, 88.00, 1.0], // 核心点
                // =========================================
                [45.00, 132.50, 0.5], // 兴凯湖 (重要但非核心)
                [49.50, 136.00, 0.3], // 阿穆尔河下游
                [43.10, 144.50, 0.4], // 日本北海道 (留鸟种群)
                [32.10, 130.30, 0.4], // 日本出水市
                [38.20, 127.20, 0.4], // 韩国铁原
                [36.00, 126.70, 0.3], // 韩国锦江河口
                [27.80, 99.60, 0.4],  // 香格里拉纳帕海
                [24.90, 102.70, 0.3], // 昆明滇池
                [30.70, 106.10, 0.2], // 四川南充 (微弱背景)
                [35.50, 97.00, 0.3],  // 冬给措纳湖
                [27.17, 77.52, 0.5],  // 印度凯奥拉德奥 (次级核心)
                [19.80, 85.30, 0.4],  // 印度奇利卡湖
                [24.50, 93.90, 0.2],  // 曼尼普尔
                [22.00, 89.00, 0.3],  // 孙德尔本斯
                [32.00, 76.00, 0.3],  // 庞大坝湖
                [25.00, 67.00, 0.2],  // 印度河三角洲
                [20.50, 96.90, 0.3],  // 缅甸茵莱湖
                [12.50, 104.20, 0.4], // 柬埔寨洞里萨湖
                [10.00, 106.00, 0.3], // 越南湄公河
                [17.00, 100.00, 0.2],  // 泰国中部
                [50.30, 92.70, 0.4],  // 蒙古乌布苏湖 (Uvs Nuur, 巨大的咸水湖盆地)
                [51.10, 100.80, 0.4], // 蒙古库苏古尔湖 (Khovsgol, 这里的“小贝加尔”)
                [47.80, 117.70, 0.3], // 蒙古贝尔湖 (Buir Lake, 鹤类关键停歇点)
                [47.70, 102.70, 0.3], // 蒙古鄂吉湖 (Ogii Lake, 水鸟天堂)
                [49.95, 115.70, 0.4], // 达乌尔自然保护区 (中蒙俄交界，生态极其丰富)
                [73.00, 126.50, 0.5], // 俄罗斯勒拿河三角洲 (Lena Delta, 极北的核心繁殖地)
                [71.40, 148.00, 0.4], // 因迪吉尔卡河湿地 (白鹤的故乡)
                [64.50, 155.00, 0.3], // 科雷马低地 (Kolyma Lowland)
                [62.00, 129.70, 0.3], // 雅库特中部湖泊群
                [55.00, 83.00, 0.3]   // 新西伯利亚水库 (Ob Sea, 西西伯利亚中转站)
            ];
            let heatLayer = null;

            

            // 线路状态管理 (增加 heatmap)
            const activeRoutes = {
                east: true,
                mid: true,
                west: true,
                heatmap: false 
            };

            // --- 1. 语言切换 ---
            function toggleLanguage() {
                const body = document.body;
                const btnText = document.getElementById('lang-btn-text');
                if (currentLang === 'zh') {
                    currentLang = 'en';
                    body.classList.add('en-mode');
                    btnText.textContent = 'CN'; 
                } else {
                    currentLang = 'zh';
                    body.classList.remove('en-mode');
                    btnText.textContent = 'EN'; 
                }
                // 刷新所有组件
                updateFilterUI(); 
                updateBirdMigration(currentMonth);
                renderSidebar(); 
                updateMonthLabel();
            }

            // --- 2. 数据中心 ---
            const birdData = {
                east: {
                    id: 'crane',
                    name_zh: "东线：丹顶鹤", name_en: "East: Red-crowned Crane",
                    color: "#FF7F50",
                    sidebar_info_zh: `<strong>习性：</strong> 沿海“逐水而居”，依赖芦苇湿地。<br><strong>路线：</strong> 盐城(冬) <i class="fas fa-arrows-alt-v"></i> 扎龙(夏)`,
                    sidebar_info_en: `<strong>Habit:</strong> Coastal dweller, wetland dependent.<br><strong>Route:</strong> Yancheng <i class="fas fa-arrows-alt-v"></i> Zhalong`,
                    monthlyData: [
                        { pos: [33.38, 120.13], desc_zh: "<b>[越冬·盐城]</b> 在芦苇丛中通过吞食鱼虾积累脂肪。", desc_en: "<b>[Wintering]</b> Building fat reserves in wetlands." },
                        { pos: [33.50, 120.20], desc_zh: "<b>[越冬末期]</b> 鹤群开始活跃，进行北迁前集结。", desc_en: "<b>[Rallying]</b> Preparing for northward migration." },
                        { pos: [37.75, 118.95], desc_zh: "<b>[北迁·黄河口]</b> 飞抵黄河三角洲停歇补给。", desc_en: "<b>[Refueling]</b> Stopover at Yellow River Delta." },
                        { pos: [41.12, 121.12], desc_zh: "<b>[北迁·辽宁]</b> 随着5°C等温线北移穿越环渤海。", desc_en: "<b>[Migration]</b> Crossing the Bohai Rim." },
                        { pos: [47.20, 124.25], desc_zh: "<b>[抵达·扎龙]</b> 终于到达繁殖地，开始筑巢。", desc_en: "<b>[Arrival]</b> Reaching Zhalong breeding grounds." },
                        { pos: [47.30, 124.30], desc_zh: "<b>[繁殖期]</b> 正在孵化卵，利用芦苇作屏障。", desc_en: "<b>[Breeding]</b> Incubation phase." },
                        { pos: [47.25, 124.20], desc_zh: "<b>[育雏期]</b> 雏鸟破壳，在浅水中学习觅食。", desc_en: "<b>[Nurturing]</b> Chicks learning to forage." },
                        { pos: [47.00, 124.00], desc_zh: "<b>[练飞期]</b> 幼鸟羽翼渐丰，家族群开始集结。", desc_en: "<b>[Fledging]</b> Young birds practicing flight." },
                        { pos: [44.50, 122.00], desc_zh: "<b>[南迁·吉林]</b> 气温骤降，避开寒冷沿海风口。", desc_en: "<b>[Southbound]</b> Avoiding coastal winds." },
                        { pos: [38.00, 117.50], desc_zh: "<b>[南迁·河北]</b> 借助秋季强劲北风滑翔。", desc_en: "<b>[Gliding]</b> Riding the autumn thermals." },
                        { pos: [34.50, 118.50], desc_zh: "<b>[南迁·江苏]</b> 抵达连云港，回到越冬地前最后一站。", desc_en: "<b>[Rest]</b> Stopover at Lianyungang." },
                        { pos: [33.38, 120.13], desc_zh: "<b>[回归·盐城]</b> 回到温暖的南方湿地，安度寒冬。", desc_en: "<b>[Return]</b> Back to winter sanctuary." }
                    ]
                },
                mid: {
                    id: 'swan',
                    name_zh: "中线：小天鹅", name_en: "Mid: Tundra Swan",
                    color: "#20c997",
                    sidebar_info_zh: `<strong>习性：</strong> 耐力惊人，能跨越内陆干旱区。<br><strong>路线：</strong> 鄱阳湖(冬) <i class="fas fa-arrows-alt-v"></i> 西伯利亚(夏)`,
                    sidebar_info_en: `<strong>Habit:</strong> High endurance, crosses arid lands.<br><strong>Route:</strong> Poyang <i class="fas fa-arrows-alt-v"></i> Siberia`,
                    monthlyData: [
                        { pos: [29.10, 116.68], desc_zh: "<b>[越冬·鄱阳湖]</b> 利用长颈挖掘浅滩下的块茎。", desc_en: "<b>[Wintering]</b> Digging for tubers at Poyang." },
                        { pos: [30.00, 115.50], desc_zh: "<b>[越冬·龙感湖]</b> 在长江中下游湖泊群间迁移。", desc_en: "<b>[Foraging]</b> Moving to find food." },
                        { pos: [34.80, 113.50], desc_zh: "<b>[北迁·黄河]</b> 飞越黄河，在三门峡库区停歇。", desc_en: "<b>[Crossing]</b> Flying over the Yellow River." },
                        { pos: [41.00, 113.00], desc_zh: "<b>[北迁·内蒙]</b> 飞越干旱草原，在岱海停歇补水。", desc_en: "<b>[Hydration]</b> Stopover at Inner Mongolia lakes." },
                        { pos: [50.00, 105.00], desc_zh: "<b>[北迁·出境]</b> 抵达贝加尔湖南岸，冰雪初融。", desc_en: "<b>[Border]</b> Reaching Lake Baikal." },
                        { pos: [53.00, 108.00], desc_zh: "<b>[抵达·苔原]</b> 到达西伯利亚繁殖地，快速筑巢。", desc_en: "<b>[Arrival]</b> Reaching Siberian Tundra." },
                        { pos: [54.00, 109.00], desc_zh: "<b>[育雏高峰]</b> 昆虫爆发提供丰富蛋白质。", desc_en: "<b>[Peak Season]</b> Abundant food supply." },
                        { pos: [53.50, 108.50], desc_zh: "<b>[换羽期]</b> 成鸟暂时失去飞行能力。", desc_en: "<b>[Molting]</b> Flightless period." },
                        { pos: [45.00, 116.00], desc_zh: "<b>[南迁·草原]</b> 寒流来袭，经由锡林郭勒南下。", desc_en: "<b>[Southbound]</b> Taking the grassland route." },
                        { pos: [37.00, 116.50], desc_zh: "<b>[南迁·山东]</b> 在黄河故道湿地停歇等待气流。", desc_en: "<b>[Rest]</b> Old Yellow River course." },
                        { pos: [31.00, 117.50], desc_zh: "<b>[南迁·安徽]</b> 抵达升金湖，利用枯水期滩涂。", desc_en: "<b>[Arrival]</b> Reaching Shengjin Lake." },
                        { pos: [29.10, 116.68], desc_zh: "<b>[回归·鄱阳湖]</b> 家族群团聚，万鸟齐鸣。", desc_en: "<b>[Reunion]</b> Wintering at Poyang Lake." }
                    ]
                },
                west: {
                    id: 'goose',
                    name_zh: "西线：斑头雁", name_en: "West: Bar-headed Goose",
                    color: "#56ccf2",
                    sidebar_info_zh: `<strong>习性：</strong> 极强心肺功能，飞越世界屋脊。<br><strong>路线：</strong> 印度(冬) <i class="fas fa-arrows-alt-v"></i> 青海湖(夏)`,
                    sidebar_info_en: `<strong>Habit:</strong> Extreme cardio, over Himalayas.<br><strong>Route:</strong> India <i class="fas fa-arrows-alt-v"></i> Qinghai Lake`,
                    monthlyData: [
                        { pos: [27.20, 88.00], desc_zh: "<b>[越冬·南亚]</b> 在印度与尼泊尔交界低地越冬。", desc_en: "<b>[Wintering]</b> South Asian lowlands." },
                        { pos: [27.20, 88.00], desc_zh: "<b>[集结]</b> 在喜马拉雅南麓盘旋，等待上升气流。", desc_en: "<b>[Waiting]</b> Circling for the monsoon." },
                        { pos: [30.00, 91.00], desc_zh: "<b>[翻越巅峰]</b> 奇迹时刻！8小时内升至海拔8000米。", desc_en: "<b>[Summit]</b> Crossing the Himalayas." },
                        { pos: [34.00, 95.00], desc_zh: "<b>[北迁·高原]</b> 穿越无人区，凭借厚绒抵御严寒。", desc_en: "<b>[Crossing]</b> Flying over no-man's land." },
                        { pos: [36.80, 100.20], desc_zh: "<b>[抵达·青海湖]</b> 利用湖心岛隔绝捕食者开始筑巢。", desc_en: "<b>[Arrival]</b> Qinghai Lake breeding grounds." },
                        { pos: [37.00, 100.00], desc_zh: "<b>[孵化期]</b> 湖中湟鱼回游提供丰富营养。", desc_en: "<b>[Nesting]</b> Building nests on islands." },
                        { pos: [36.90, 100.40], desc_zh: "<b>[育雏期]</b> 雏鸟只能游泳躲避天敌。", desc_en: "<b>[Rearing]</b> Avoiding predators." },
                        { pos: [36.80, 100.20], desc_zh: "<b>[练飞期]</b> 幼鸟羽翼丰满，开始编队飞行。", desc_en: "<b>[Training]</b> Formation flight practice." },
                        { pos: [34.00, 92.00], desc_zh: "<b>[南迁·唐古拉]</b> 经由唐古拉山口向南撤离。", desc_en: "<b>[Departure]</b> Crossing Tanggula Pass." },
                        { pos: [30.00, 85.00], desc_zh: "<b>[南迁·河谷]</b> 在雅鲁藏布江上游休整。", desc_en: "<b>[Rest]</b> Yarlung Tsangpo Valley." },
                        { pos: [28.00, 84.00], desc_zh: "<b>[飞越·干城章嘉]</b> 借助秋季北风高速俯冲越过雪山。", desc_en: "<b>[Descent]</b> Over Kangchenjunga." },
                        { pos: [27.20, 88.00], desc_zh: "<b>[回归·南亚]</b> 在温暖的河谷平原降落。", desc_en: "<b>[Landing]</b> Return to the warmth." }
                    ]
                }
            };

            var map = L.map('map', { scrollWheelZoom: false }).setView([36.0, 104.0], 4);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap, &copy; CARTO'
            }).addTo(map);

            // --- 台湾地区灰色遮罩 ---
            var taiwanGeoJson = {
                "type": "Feature",
                "properties": { "name": "Taiwan" },
                "geometry": {
                    "type": "MultiPolygon",
                    "coordinates": [[[[121.941406,24.753232],[121.931641,24.612845],[121.819824,24.359554],[121.554199,24.114166],[121.583496,23.634487],[121.439453,23.153114],[120.878906,21.930295],[120.839355,21.945431],[120.727539,22.385658],[120.588867,22.583643],[120.169922,23.17303],[120.070312,23.561461],[120.18457,23.893395],[120.406738,24.211687],[120.588867,24.487149],[120.816895,24.843937],[121.039062,25.058106],[121.510254,25.292033],[121.858887,25.162677],[122.004883,25.120819],[121.941406,24.753232]]]]
                }
            };

            L.geoJSON(taiwanGeoJson, {
                style: function (feature) {
                    return {
                        fillColor: '#808080', 
                        fillOpacity: 0.7,     
                        color: '#666666',     
                        weight: 1,            
                        opacity: 1            
                    };
                }
            }).addTo(map);

            var historyLayerGroup = L.layerGroup().addTo(map);
            let currentTemperatureLayer = null;

            // --- 横向过滤器自定义控件 ---
            var filterControl = L.control({position: 'topright'});
            
            filterControl.onAdd = function (map) {
                var div = L.DomUtil.create('div', 'map-filter-control');
                L.DomEvent.disableClickPropagation(div); 
                div.id = 'map-filter-ui'; 
                return div;
            };
            
            filterControl.addTo(map);

            // [核心修改] 刷新过滤器UI的函数 (包含热力图)
            function updateFilterUI() {
                const container = document.getElementById('map-filter-ui');
                if (!container) return;

                const title = currentLang === 'zh' ? '显示图层' : 'Map Layers';
                let html = `<div class="filter-title">${title}</div>`;

                // 1. 生成线路开关
                Object.entries(birdData).forEach(([key, bird]) => {
                    const nameFull = currentLang === 'zh' ? bird.name_zh : bird.name_en;
                    const name = nameFull.split(/[:：]/)[0]; 
                    
                    const isActive = activeRoutes[key] ? 'active' : '';
                    const color = bird.color;
                    const bgStyle = activeRoutes[key] ? `background: ${color}; border-color:${color}` : `background: transparent; border-color: #ddd`;

                    html += `
                        <div class="filter-item ${isActive}" onclick="toggleRoute('${key}', this)" data-route="${key}">
                            <div class="filter-checkbox" style="${bgStyle}" data-color="${color}"></div>
                            <div class="filter-label">${name}</div>
                        </div>
                    `;
                });

                // 2. 生成热力图开关
                const hmActive = activeRoutes.heatmap ? 'active' : '';
                // 按钮使用金色/橙色
                const hmColor = '#FF8C00'; 
                const hmBgStyle = activeRoutes.heatmap ? `background: ${hmColor}; border-color:${hmColor}` : `background: transparent; border-color: #ddd`;
                const hmLabel = currentLang === 'zh' ? '栖息地热力' : 'Habitat Heat';

                html += `
                    <div class="filter-item ${hmActive}" onclick="toggleHeatmap(this)">
                        <div class="filter-checkbox" style="${hmBgStyle}" data-color="${hmColor}"></div>
                        <div class="filter-label" style="color:#d35400;">${hmLabel}</div>
                    </div>
                `;

                container.innerHTML = html;
            }

            // 定义一个全局变量存储信标
            let pulseMarkers = [];
            const keyLocations = [
                // --- 东线：丹顶鹤 ---
                { pos: [33.38, 120.13], type: 'winter' },   // 越冬：盐城
                { pos: [47.20, 124.25], type: 'breeding' }, // 繁殖：扎龙

                // --- 中线：小天鹅 ---
                { pos: [29.10, 116.68], type: 'winter' },   // 越冬：鄱阳湖
                { pos: [53.00, 108.00], type: 'breeding' }, // 繁殖：西伯利亚

                // --- 西线：斑头雁 ---
                { pos: [27.20, 88.00],  type: 'winter' },   // 越冬：南亚
                { pos: [36.80, 100.20], type: 'breeding' }  // 繁殖：青海湖
            ];

            // [核心] 切换热力图逻辑（包含地图变暗逻辑）
            function toggleHeatmap(element) {
                activeRoutes.heatmap = !activeRoutes.heatmap;
                const checkbox = element.querySelector('.filter-checkbox');
                const color = checkbox.dataset.color;
                
                // [核心优化] 切换地图容器的 class 来触发夜间模式滤镜
                // 这比直接 setOpacity 性能更好，效果也更平滑
                const mapContainer = document.getElementById('map');
                
                if (activeRoutes.heatmap) {
                    element.classList.add('active');
                    checkbox.style.background = color;
                    checkbox.style.borderColor = color;
                    
                    // 开启夜间模式：压暗底图
                    mapContainer.classList.add('night-mode');
                    
                    // 创建/显示热力图层
                    if (!heatLayer) {
                        heatLayer = L.heatLayer(heatMapPoints, {
                            max: 0.3,
                            radius: 40,       // [调大] 让光晕范围更广
                            blur: 20,         // [调大] 让边缘更柔和，像雾气一样
                            maxZoom: 9,       // 调整最大缩放级别，防止放大后光点散开
                            minOpacity: 0.08, // [关键] 即使是低热度区域也有一点点可见度，增加背景噪音
                            gradient: {
                                // 0.0 - 0.3: 背景底色（深红/紫），极低透明度，模拟外围活动区
                                0.1: 'rgba(139, 0, 0, 0.8)',  
                                0.3: 'rgba(255, 69, 0, 0.8)',  
                                // 0.6: 主体颜色（金橙色），高饱和度
                                0.6: 'rgba(255, 165, 0, 0.95)', 
                                // 0.9 - 1.0: 核心爆发（亮黄到纯白），模拟高密度聚集
                                0.9: 'rgba(255, 255, 0, 1.0)', 
                                1.0: '#FFFFFF' 
                            }
                        });
                    }
                    heatLayer.addTo(map);
                    
                    // [核心修改] 添加带类型的脉冲信标
                    keyLocations.forEach(loc => {
                        // 根据类型决定 CSS 类名
                        const typeClass = loc.type === 'breeding' ? 'pulse-breeding' : 'pulse-winter';
                        
                        const pulseIcon = L.divIcon({
                            className: '', // 清空 Leaflet 默认类，避免干扰
                            // 在 HTML 中加入 typeClass
                            html: `<div class="pulse-icon ${typeClass}">
                                    <div class="pulse-ring"></div>
                                    <div class="pulse-ring"></div>
                                </div>`,
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        });
                        
                        const marker = L.marker(loc.pos, { // 注意这里取 loc.pos
                            icon: pulseIcon, 
                            interactive: false, 
                            zIndexOffset: -100 
                        }).addTo(map);
                        
                        pulseMarkers.push(marker);
                    });

                } else {
                    element.classList.remove('active');
                    checkbox.style.background = 'transparent';
                    checkbox.style.borderColor = '#ddd';
                    
                    // 关闭夜间模式：恢复底图亮度
                    mapContainer.classList.remove('night-mode');
                    
                    // 移除图层
                    if (heatLayer) {
                        map.removeLayer(heatLayer);
                    }
                    // [新增] 移除脉冲信标
                    pulseMarkers.forEach(m => map.removeLayer(m));
                    pulseMarkers = [];
                }
                
                // 强制重绘气温层以适应新的亮度（如果需要）
                // updateTemperatureLayer(currentMonth); 
            }

            // 切换线路逻辑
            function toggleRoute(routeKey, element) {
                activeRoutes[routeKey] = !activeRoutes[routeKey];
                
                const checkbox = element.querySelector('.filter-checkbox');
                const color = checkbox.dataset.color;
                
                if (activeRoutes[routeKey]) {
                    element.classList.add('active');
                    checkbox.style.background = color;
                    checkbox.style.borderColor = color;
                } else {
                    element.classList.remove('active');
                    checkbox.style.background = 'transparent';
                    checkbox.style.borderColor = '#ddd';
                }

                // 更新背景图片
                const imgEl = document.getElementById(`bg-img-${routeKey}`);
                if (imgEl) {
                    if (activeRoutes[routeKey]) {
                        imgEl.classList.add('active');
                    } else {
                        imgEl.classList.remove('active');
                    }
                }

                updateBirdMigration(currentMonth);
            }

            function getBirdSVG(type, color) {
                const craneShape = `<path d="M20 5 L25 15 L38 12 L22 25 L20 38 L18 25 L2 12 L15 15 Z" fill="${color}" stroke="white" stroke-width="1.5" stroke-linejoin="round"/><path d="M20 5 L20 25" stroke="white" stroke-width="1" opacity="0.5"/>`;
                const swanShape = `<path d="M20 2 L28 15 L38 8 L25 22 L20 35 L15 22 L2 8 L12 15 Z" fill="${color}" stroke="white" stroke-width="1.5" stroke-linejoin="round"/><path d="M20 2 L20 22" stroke="white" stroke-width="1" opacity="0.5"/>`;
                const gooseShape = `<path d="M20 0 L26 18 L36 24 L20 28 L4 24 L14 18 Z" fill="${color}" stroke="white" stroke-width="1.5" stroke-linejoin="round"/><path d="M20 0 L20 28" stroke="white" stroke-width="1" opacity="0.5"/>`;
                const shapes = { 'crane': craneShape, 'swan': swanShape, 'goose': gooseShape };
                return `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" style="overflow:visible;">
                            <filter id="ds-${type}"><feDropShadow dx="0" dy="3" stdDeviation="2" flood-color="rgba(0,0,0,0.3)"/></filter>
                            <g filter="url(#ds-${type})">${shapes[type] || shapes['crane']}</g>
                        </svg>`;
            }

            function renderSidebar() {
                const container = document.getElementById('sidebar-content');
                const title = currentLang === 'zh' ? '代表种群档案' : 'Species Archive';
                let html = `<div class="sidebar-title">${title}</div>`;
                
                Object.values(birdData).forEach(bird => {
                    const name = currentLang === 'zh' ? bird.name_zh : bird.name_en;
                    const info = currentLang === 'zh' ? bird.sidebar_info_zh : bird.sidebar_info_en;
                    html += `<div class="bird-mini-card" style="border-left-color: ${bird.color};"><div class="bird-mini-title" style="color:${bird.color};">${name}</div><div class="bird-mini-text">${info}</div></div>`;
                });

                const legendTitle = currentLang === 'zh' ? '图例说明' : 'Legend';
                const legendContent = currentLang === 'zh' 
                    ? `<div class="legend-item"><span class="legend-dot" style="background:#3388ff;"></span>越冬地</div><div class="legend-item"><span class="legend-dot" style="background:#ff3333;"></span>繁殖地</div><div class="legend-item"><span class="legend-dot" style="background:#ffcc00;"></span>途经地</div><div class="legend-item"></div><div class="legend-item"><span class="legend-line" style="background:#666;"></span>北迁 (春)</div><div class="legend-item"><span class="legend-line" style="background:#666; border-top: 2px dashed #666; background:none; height:0;"></span>南迁 (秋)</div>`
                    : `<div class="legend-item"><span class="legend-dot" style="background:#3388ff;"></span>Wintering</div><div class="legend-item"><span class="legend-dot" style="background:#ff3333;"></span>Breeding</div><div class="legend-item"><span class="legend-dot" style="background:#ffcc00;"></span>Stopover</div><div class="legend-item"></div><div class="legend-item"><span class="legend-line" style="background:#666;"></span>Spring</div><div class="legend-item"><span class="legend-line" style="background:#666; border-top: 2px dashed #666; background:none; height:0;"></span>Autumn</div>`;

                html += `<div class="sidebar-title mt-3" style="padding-top:5px;">${legendTitle}</div><div class="legend-grid">${legendContent}</div>`;
                container.innerHTML = html;
            }

            function updateBirdMigration(month) {
                routeDrawTimeouts.forEach(t => clearTimeout(t));
                routeDrawTimeouts = [];

                historyLayerGroup.clearLayers();
                const monthNamesEn = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

                Object.entries(birdData).forEach(([key, bird]) => {
                    
                    if (!activeRoutes[key]) {
                        if (birdMarkers[bird.id]) {
                            map.removeLayer(birdMarkers[bird.id]);
                            delete birdMarkers[bird.id];
                        }
                        return; 
                    }

                    const turfPoints = bird.monthlyData.map(d => [d.pos[1], d.pos[0]]);
                    
                    for (let i = 0; i < month - 1; i++) {
                        const historyPos = bird.monthlyData[i].pos;
                        const historyIcon = L.divIcon({
                            className: '', 
                            html: `<div class="history-dot" style="--bird-color:${bird.color};"></div>`,
                            iconSize: [8, 8], iconAnchor: [4, 4]
                        });
                        L.marker(historyPos, { icon: historyIcon, interactive: false, zIndexOffset: 500 }).addTo(historyLayerGroup);
                    }

                    if (month > 2) { 
                        let stablePathPoints = turfPoints.slice(0, month - 1); 
                        let cleanStablePath = stablePathPoints.filter((pt, i) => i===0 || !(pt[0]===stablePathPoints[i-1][0] && pt[1]===stablePathPoints[i-1][1]));
                        
                        if (cleanStablePath.length >= 2) {
                            const line = turf.lineString(cleanStablePath);
                            const curved = turf.bezierSpline(line, {resolution: 10000, sharpness: 0.5});
                            L.geoJSON(curved, { 
                                style: { color: bird.color, weight: 2, opacity: 0.6, dashArray: month>8?'5,5':null } 
                            }).addTo(historyLayerGroup);
                        }
                    }

                    const monthData = bird.monthlyData[month - 1];
                    const currentPos = monthData.pos; 
                    const currentDesc = currentLang === 'zh' ? monthData.desc_zh : monthData.desc_en;
                    const birdName = currentLang === 'zh' ? bird.name_zh : bird.name_en;
                    const monthLabel = currentLang === 'zh' ? `${month}月` : monthNamesEn[month-1];

                    let bearing = 0;
                    if (month > 1) {
                        const prevPos = bird.monthlyData[month-2].pos;
                        const start = turf.point([prevPos[1], prevPos[0]]);
                        const end = turf.point([currentPos[1], currentPos[0]]);
                        bearing = turf.bearing(start, end);
                    }

                    if (birdMarkers[bird.id]) {
                        const marker = birdMarkers[bird.id];
                        marker.setLatLng(currentPos);
                        const tooltipHtml = `<div style="border-bottom: 2px solid ${bird.color}; padding-bottom:5px; margin-bottom:5px; font-weight:bold; color:${bird.color}">
                            ${birdName} <span style="font-size:0.7em; color:#888; background:#eee; padding:2px 6px; border-radius:10px;">${monthLabel}</span>
                         </div>
                         <div style="font-size:0.85rem;">${currentDesc}</div>`;
                        marker.setTooltipContent(tooltipHtml);
                        const iconDiv = marker.getElement().querySelector('.geo-bird-icon');
                        if (iconDiv) iconDiv.style.transform = `rotate(${bearing}deg)`;
                    } else {
                        const svgHtml = getBirdSVG(bird.id, bird.color);
                        const birdIcon = L.divIcon({
                            className: 'bird-icon-wrapper', 
                            html: `<div class="geo-bird-icon" style="transform: rotate(${bearing}deg);">${svgHtml}</div>`, 
                            iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -25]
                        });
                        const newMarker = L.marker(currentPos, { icon: birdIcon, zIndexOffset: 1000 })
                            .bindTooltip(
                                `<div style="border-bottom: 2px solid ${bird.color}; padding-bottom:5px; margin-bottom:5px; font-weight:bold; color:${bird.color}">
                                    ${birdName} <span style="font-size:0.7em; color:#888; background:#eee; padding:2px 6px; border-radius:10px;">${monthLabel}</span>
                                 </div>
                                 <div style="font-size:0.85rem;">${currentDesc}</div>`, 
                                { direction: 'top', sticky: true, className: 'bird-status-tooltip', offset: [0, -20] }
                            ).addTo(map); 
                        birdMarkers[bird.id] = newMarker;
                    }

                    if (month > 1) {
                        const timeoutId = setTimeout(() => {
                            if (!activeRoutes[key]) return; 
                            let fullPathPoints = turfPoints.slice(0, month); 
                            let cleanFullPath = fullPathPoints.filter((pt, i) => i===0 || !(pt[0]===fullPathPoints[i-1][0] && pt[1]===fullPathPoints[i-1][1]));
                            
                            if (cleanFullPath.length >= 2) {
                                const line = turf.lineString(cleanFullPath);
                                const curved = turf.bezierSpline(line, {resolution: 10000, sharpness: 0.5});
                                L.geoJSON(curved, { 
                                    style: { color: bird.color, weight: 2, opacity: 0.6, dashArray: month>8?'5,5':null } 
                                }).addTo(historyLayerGroup);
                            }
                        }, 1500); 
                        routeDrawTimeouts.push(timeoutId);
                    }
                });
            }

            function updateTemperatureLayer(monthIndex) {
                currentMonth = monthIndex;
                updateMonthLabel();
                const monthStr = monthIndex.toString().padStart(2, '0');
                const newTileUrl = `${TILE_BASE_URL}${monthStr}/{z}/{x}/{y}.png`; 
                const nextLayer = L.tileLayer(newTileUrl, { minZoom: 3, maxZoom: 10, opacity: 0, tms: false, zIndex: 50 });
                nextLayer.addTo(map);
                setTimeout(() => { if(nextLayer.getContainer()) nextLayer.setOpacity(1); }, 50);
                if (currentTemperatureLayer) {
                    const oldLayer = currentTemperatureLayer;
                    setTimeout(() => { map.removeLayer(oldLayer); }, 600);
                }
                currentTemperatureLayer = nextLayer;
                updateBirdMigration(monthIndex);
            }

            function updateMonthLabel() {
                const monthNamesEn = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                const label = document.getElementById('current-month-label');
                if (currentLang === 'zh') {
                    label.textContent = `${currentMonth}月`;
                } else {
                    label.textContent = monthNamesEn[currentMonth - 1];
                }
            }

            let isPlaying = false; let playInterval = null;
            const slider = document.getElementById('month-slider');
            
            function togglePlay() {
                if (isPlaying) {
                    clearInterval(playInterval);
                    document.getElementById('play-btn').innerHTML = '<i class="fas fa-play"></i>';
                    isPlaying = false;
                } else {
                    document.getElementById('play-btn').innerHTML = '<i class="fas fa-pause"></i>';
                    isPlaying = true;
                    playInterval = setInterval(() => {
                        let nextVal = parseInt(slider.value) + 1;
                        if (nextVal > 12) nextVal = 1;
                        slider.value = nextVal;
                        updateTemperatureLayer(nextVal);
                    }, 1500);
                }
            }

            slider.addEventListener('input', function() { 
                if (isPlaying) togglePlay(); 
                updateTemperatureLayer(parseInt(this.value)); 
            });

            // --- 初始化 ---
            updateTemperatureLayer(1);
            renderSidebar(); 
            updateFilterUI(); 

        </script>
    </body>
</html>